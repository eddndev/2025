---
import fs from 'fs';
import path from 'path';

// LEER FOTOS REALES
const imagesDir = path.join(process.cwd(), 'public/images/memories');
let imageFiles = [];

try {
  if (fs.existsSync(imagesDir)) {
    imageFiles = fs.readdirSync(imagesDir)
      .filter(file => file.endsWith('.webp'))
      .map(file => `/images/memories/${file}`); 
  }
} catch (e) {
  console.error("Error leyendo imágenes:", e);
}

imageFiles = imageFiles.sort(() => Math.random() - 0.5);
---

<section id="gallery" class="relative min-h-screen w-full bg-slate-950 py-0">
  
  <!-- Título Flotante (Sobre las fotos) -->
  <div class="absolute top-10 left-0 w-full text-center z-20 pointer-events-none opacity-0 reveal-gallery mix-blend-difference">
    <span class="text-white/80 font-mono text-xs tracking-[0.5em] uppercase drop-shadow-md">Evidencias</span>
  </div>

  <!-- MASONRY GRID FULL BLEED (Sin huecos, sin padding) -->
  <div class="columns-2 md:columns-4 lg:columns-5 gap-0 space-y-0 w-full">
    
    {imageFiles.map((imgSrc, index) => (
      <div class="break-inside-avoid opacity-0 reveal-item mb-0 relative group">
        <!-- Overlay sutil al hover -->
        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-500 z-10 pointer-events-none"></div>
        
        <img 
          src={imgSrc} 
          loading="lazy"
          class="w-full h-auto object-cover block" 
          alt={`Recuerdo ${index + 1}`} 
        />
      </div>
    ))}

  </div>
  
  <!-- Data Bridge para el script -->
  <div id="gallery-data" data-images={JSON.stringify(imageFiles)} class="hidden"></div>
  
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  document.addEventListener('astro:page-load', () => {
    
    // --- PRELOADER ASÍNCRONO ---
    // Empezamos a descargar las fotos en segundo plano 2 segundos después
    // de que cargue la página, para no afectar el renderizado inicial.
    setTimeout(() => {
      const dataEl = document.getElementById('gallery-data');
      if (dataEl && dataEl.dataset.images) {
        try {
          const images = JSON.parse(dataEl.dataset.images);
          console.log(`[Gallery] Iniciando precarga de ${images.length} imágenes...`);
          
          images.forEach((src) => {
            const img = new Image();
            img.src = src; // Esto fuerza al navegador a cachearla
          });
        } catch (e) {
          console.error("Error precargando galería", e);
        }
      }
    }, 2000);


    // --- ANIMACIONES ---
    gsap.to('.reveal-gallery', {
      opacity: 1, y: 0, duration: 1.5, ease: "power2.out", delay: 0.5
    });

    const items = document.querySelectorAll('.reveal-item');
    
    ScrollTrigger.batch(items, {
      onEnter: batch => gsap.to(batch, {
        opacity: 1, 
        scale: 1, 
        stagger: 0.02, // Muy rápido para efecto cascada
        duration: 0.6, 
        ease: "power2.out",
        overwrite: true
      }),
      start: "top 100%" // Animar apenas toque el viewport
    });

    gsap.set(items, { opacity: 0 }); // Sin escala ni movimiento Y, solo fade para pureza
  });
</script>