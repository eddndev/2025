---
---
<section id="melancholy" class="h-screen w-full bg-slate-950 relative overflow-hidden flex items-center justify-center text-slate-100 p-0 m-0">
  
  <!-- CANVAS DE LLUVIA -->
  <canvas id="rain-canvas" class="absolute inset-0 w-full h-full pointer-events-none opacity-40 mix-blend-screen"></canvas>

  <!-- INDICADOR SCROLL -->
  <div id="scroll-indicator" class="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 animate-fade-in z-50 pointer-events-none mix-blend-difference opacity-50">
    <span class="text-[9px] font-mono uppercase tracking-widest text-white/60">Inicio</span>
    <div class="w-px h-8 bg-white/20 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1/2 bg-white animate-scroll-down"></div>
    </div>
  </div>

  <!-- CONTENEDOR CONTENIDO -->
  <div class="pinned-content relative w-full max-w-6xl px-12 md:px-32 lg:px-40 text-center h-[60vh] flex flex-col items-center justify-center z-10">
    
    <!-- Step 1: 2025 -->
    <div class="step absolute inset-0 flex flex-col items-center justify-center opacity-100 translate-y-0">
      <span class="text-[10px] font-mono tracking-[0.4em] text-white/20 uppercase block mb-6">Carta Abierta</span>
      <h2 class="text-7xl md:text-[8rem] font-black tracking-tighter leading-none text-white opacity-90">
        2025<span class="text-white/10">.</span>
      </h2>
    </div>

    <!-- Step 2 -->
    <div class="step absolute inset-0 flex flex-col items-center justify-center opacity-0 translate-y-8">
      <p class="text-xl md:text-3xl font-light leading-relaxed text-white/90 w-full max-w-[85vw] md:max-w-3xl mx-auto">
        Quizás este año no inició de la mejor manera, provoqué demasiados malestares emocionales, y, sinceramente me disculpo por eso, aunque sé en lo profundo de mi conciencia que las disculpas solas no bastan.
      </p>
    </div>

    <!-- Step 3 -->
    <div class="step absolute inset-0 flex flex-col items-center justify-center opacity-0 translate-y-8">
      <p class="text-xl md:text-4xl font-light leading-relaxed text-white/90 w-full max-w-[85vw] md:max-w-3xl mx-auto">
        Me gustaría decir que reafirmé lo que quería, <span class="text-white font-bold italic">tú</span>, y una vida contigo.
      </p>
    </div>

    <!-- Step 4 -->
    <div class="step absolute inset-0 flex flex-col items-center justify-center opacity-0 translate-y-8">
      <p class="text-lg md:text-2xl font-light leading-relaxed opacity-80 w-full max-w-[85vw] md:max-w-2xl mx-auto">
        Realmente no es que lo dudara, pero la invasión de no merecer ser amado fué tanta que tomé malas decisiones, hiriéndote y afectándonos.
      </p>
    </div>

  </div>

</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // --- RAIN EFFECT LOGIC ---
  class RainEffect {
    canvas: HTMLCanvasElement;
    ctx: CanvasRenderingContext2D;
    width: number;
    height: number;
    drops: Drop[] = [];
    splashes: Splash[] = [];
    animationId: number | null = null;

    constructor() {
      this.canvas = document.getElementById('rain-canvas') as HTMLCanvasElement;
      if (!this.canvas) return;
      
      this.ctx = this.canvas.getContext('2d')!;
      this.width = window.innerWidth;
      this.height = window.innerHeight;
      this.canvas.width = this.width;
      this.canvas.height = this.height;

      this.initDrops();
      this.loop = this.loop.bind(this);
      this.resize = this.resize.bind(this);
      
      window.addEventListener('resize', this.resize);
      this.loop();
    }

    initDrops() {
      // Cantidad de gotas basada en ancho de pantalla
      const count = Math.floor(this.width / 5); 
      for (let i = 0; i < count; i++) {
        this.drops.push(new Drop(this.width, this.height));
      }
    }

    resize() {
      this.width = window.innerWidth;
      this.height = window.innerHeight;
      this.canvas.width = this.width;
      this.canvas.height = this.height;
      this.drops = [];
      this.initDrops();
    }

    loop() {
      this.ctx.clearRect(0, 0, this.width, this.height);

      // Update & Draw Drops
      this.drops.forEach(drop => {
        drop.update();
        drop.draw(this.ctx);
        
        // Check collision with "ground" (bottom of screen)
        if (drop.y >= this.height) {
          drop.reset();
          // Create splash
          if (Math.random() > 0.7) { // No siempre, para no saturar
             this.createSplash(drop.x, this.height);
          }
        }
      });

      // Update & Draw Splashes
      for (let i = this.splashes.length - 1; i >= 0; i--) {
        const splash = this.splashes[i];
        splash.update();
        splash.draw(this.ctx);
        if (splash.life <= 0) {
          this.splashes.splice(i, 1);
        }
      }

      this.animationId = requestAnimationFrame(this.loop);
    }

    createSplash(x: number, y: number) {
      for (let i = 0; i < 3; i++) {
        this.splashes.push(new Splash(x, y));
      }
    }
  }

  class Drop {
    x: number;
    y: number;
    speed: number;
    length: number;
    opacity: number;
    canvasWidth: number;
    canvasHeight: number;

    constructor(w: number, h: number) {
      this.canvasWidth = w;
      this.canvasHeight = h;
      this.init(true);
    }

    init(randomY = false) {
      this.x = Math.random() * this.canvasWidth;
      this.y = randomY ? Math.random() * this.canvasHeight : -50;
      this.speed = Math.random() * 10 + 15; // Velocidad de caída rápida
      this.length = Math.random() * 20 + 10;
      this.opacity = Math.random() * 0.2 + 0.1; // Muy sutil
    }

    reset() {
      this.init();
    }

    update() {
      this.y += this.speed;
    }

    draw(ctx: CanvasRenderingContext2D) {
      ctx.beginPath();
      ctx.moveTo(this.x, this.y);
      ctx.lineTo(this.x, this.y + this.length);
      ctx.strokeStyle = `rgba(200, 210, 255, ${this.opacity})`;
      ctx.lineWidth = 1;
      ctx.stroke();
    }
  }

  class Splash {
    x: number;
    y: number;
    vx: number;
    vy: number;
    life: number;
    
    constructor(x: number, y: number) {
      this.x = x;
      this.y = y;
      this.vx = (Math.random() - 0.5) * 4;
      this.vy = Math.random() * -5 - 2; // Salta hacia arriba
      this.life = 1; // Vida de 1.0 a 0
    }

    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += 0.2; // Gravedad
      this.life -= 0.05;
    }

    draw(ctx: CanvasRenderingContext2D) {
      ctx.beginPath();
      ctx.arc(this.x, this.y, 1, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(200, 210, 255, ${this.life * 0.3})`;
      ctx.fill();
    }
  }


  // --- SCROLL LOGIC ---
  const section = document.getElementById('melancholy');
  const indicator = document.getElementById('scroll-indicator');
  const steps = section ? section.querySelectorAll('.step') : [];

  if (section && steps.length > 0) {
    
    // Iniciar lluvia
    new RainEffect();

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: "top top",
        end: "+=6000",
        pin: true,
        scrub: 1,
        onUpdate: (self) => {
          if (self.progress > 0.02 && indicator) {
            gsap.to(indicator, { opacity: 0, duration: 0.2, overwrite: true });
          }
        }
      }
    });

    steps.forEach((step, index) => {
      if (index === 0) {
        tl.to(step, { 
          opacity: 0, 
          y: -50, 
          filter: "blur(10px)", 
          duration: 1.5, 
          ease: "power2.in" 
        }, 0);
      } else {
        tl.to(step, {
          opacity: 1,
          y: 0,
          duration: 3,
          ease: "power2.out"
        }, ">-1");
        
        tl.to(step, { opacity: 1, duration: 5 }); 
      }

      if (index < steps.length - 1) {
        tl.to(step, {
          opacity: 0,
          y: -60,
          filter: "blur(8px)",
          duration: 2.5,
          ease: "power1.inOut"
        }, ">-1.5");
      }
    });

    // Resize handling
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        ScrollTrigger.refresh();
      }, 200);
    });
  }
</script>

<style>
  @keyframes scroll-down {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(100%); }
  }
  .animate-scroll-down {
    animation: scroll-down 1.5s cubic-bezier(0.76, 0, 0.24, 1) infinite;
  }
</style>